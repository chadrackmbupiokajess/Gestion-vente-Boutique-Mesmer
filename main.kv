#:kivy 2.1.0
#:import get_color_from_hex kivy.utils.get_color_from_hex

MDScreenManager:
    id: screen_manager

    MDScreen:
        name: 'main_screen'
        MDBottomNavigation:
            id: bottom_nav
            panel_color: get_color_from_hex("#F7F7F7")
            selected_color_background: get_color_from_hex("#E7E7E7")
            text_color_active: 1, 0, 0, 1
            on_switch_tabs: app.on_tab_switch()

            MDBottomNavigationItem:
                name: 'products_screen'
                text: 'Produits'
                icon: 'package-variant'
                MDBoxLayout:
                    orientation: 'vertical'
                    MDTopAppBar:
                        title: "Gestion des Produits"
                        elevation: 4
                        right_action_items: [["currency-usd", lambda x: app.show_rate_dialog()]]
                    MDBoxLayout:
                        size_hint_y: None
                        height: "48dp"
                        padding: "10dp"
                        MDTextField:
                            id: search_field
                            hint_text: "Rechercher un produit..."
                            icon_left: "magnify"
                            on_text: app.search_products()
                    MDScrollView:
                        MDList:
                            id: product_list
                MDFloatingActionButton:
                    icon: "plus"
                    pos_hint: {"center_x": 0.5, "center_y": 0.15}
                    on_release: app.show_add_product_dialog()

            MDBottomNavigationItem:
                name: 'clients_screen'
                text: 'Clients'
                icon: 'account-group'
                MDBoxLayout:
                    orientation: 'vertical'
                    MDTopAppBar:
                        title: "Gestion des Clients"
                        elevation: 4
                    MDScrollView:
                        MDList:
                            id: client_list
                MDFloatingActionButton:
                    icon: "plus"
                    pos_hint: {"center_x": 0.5, "center_y": 0.15}
                    on_release: app.show_add_client_dialog()

            MDBottomNavigationItem:
                name: 'sales_screen'
                text: 'Ventes'
                icon: 'point-of-sale'
                MDBoxLayout:
                    orientation: 'vertical'
                    MDTopAppBar:
                        title: "Historique des Ventes"
                        elevation: 4

                    MDBoxLayout:
                        orientation: 'horizontal'
                        size_hint_y: None
                        height: "48dp"
                        padding: "10dp"
                        spacing: "10dp"
                        MDTextField:
                            id: sales_date_filter_field
                            hint_text: "Sélectionner une date"
                            mode: "rectangle"
                            readonly: True
                            on_touch_down: app.show_sales_date_picker() if self.collide_point(*args[1].pos) else False
                        MDIconButton:
                            icon: "calendar"
                            on_release: app.show_sales_date_picker()
                        MDIconButton:
                            icon: "close-circle"
                            on_release: app.clear_sales_date_filter()

                    MDScrollView:
                        MDList:
                            id: sales_list
                MDFloatingActionButton:
                    icon: "plus"
                    pos_hint: {"center_x": 0.5, "center_y": 0.15}
                    on_release: app.go_to_new_sale_screen()

            MDBottomNavigationItem:
                name: 'reports_screen'
                text: 'Rapports'
                icon: 'chart-bar'

                MDBoxLayout:
                    orientation: 'vertical'
                    MDTopAppBar:
                        title: "Rapports et Statistiques"
                        elevation: 4

                    MDBoxLayout:
                        orientation: 'vertical'
                        padding: "20dp"
                        spacing: "20dp"

                        MDBoxLayout: # Nouveau conteneur pour les filtres de rapport
                            orientation: 'horizontal'
                            size_hint_y: None
                            height: "48dp"
                            spacing: "10dp"
                            MDTextField:
                                id: reports_date_filter_field
                                hint_text: "Période du rapport"
                                mode: "rectangle"
                                readonly: True
                                on_touch_down: app.show_reports_date_picker() if self.collide_point(*args[1].pos) else False
                            MDIconButton:
                                icon: "calendar"
                                on_release: app.show_reports_date_picker()
                            MDIconButton:
                                icon: "close-circle"
                                on_release: app.clear_reports_date_filter()

                        MDBoxLayout: # Boutons de filtre rapide
                            orientation: 'horizontal'
                            size_hint_y: None
                            height: "48dp"
                            spacing: "10dp"
                            MDFlatButton:
                                text: "Jour"
                                on_release: app.set_reports_filter_period('day')
                            MDFlatButton:
                                text: "Semaine"
                                on_release: app.set_reports_filter_period('week')
                            MDFlatButton:
                                text: "Mois"
                                on_release: app.set_reports_filter_period('month')
                            MDFlatButton:
                                text: "Total"
                                on_release: app.set_reports_filter_period('all')

                        MDLabel:
                            id: total_revenue_label
                            text: "Chiffre d'affaires total : 0 Fc"
                            halign: 'center'
                            font_style: 'H5'

                        MDLabel:
                            text: "Produits les plus vendus"
                            halign: 'center'
                            font_style: 'H6'

                        MDScrollView:
                            MDList:
                                id: best_selling_list

    MDScreen:
        name: 'new_sale_screen'
        MDBoxLayout:
            orientation: 'vertical'
            MDTopAppBar:
                title: "Nouvelle Vente"
                elevation: 4
                left_action_items: [["arrow-left", lambda x: app.go_to_main_screen()]]
            
            MDBoxLayout:
                orientation: 'horizontal'
                padding: "10dp"
                spacing: "10dp"

                MDBoxLayout:
                    orientation: 'vertical'
                    size_hint_x: 0.4
                    spacing: "10dp"
                    MDTextField:
                        id: sale_search_field
                        hint_text: "Rechercher un produit..."
                        mode: "rectangle"
                        on_text: app.search_products_for_sale()
                        on_text_validate: app.handle_sale_search_enter()
                    MDScrollView:
                        MDList:
                            id: search_results_list

                MDBoxLayout:
                    orientation: 'vertical'
                    size_hint_x: 0.6
                    MDLabel:
                        text: "Panier"
                        halign: "center"
                        font_style: "H6"
                        size_hint_y: None
                        height: self.texture_size[1]
                        padding_y: "10dp"
                    MDScrollView:
                        MDList:
                            id: cart_list
                    MDBoxLayout:
                        size_hint_y: None
                        height: "60dp"
                        padding: "10dp"
                        MDLabel:
                            id: total_label
                            text: "Total: 0.00 Fc"
                            font_style: "H6"
                        MDRaisedButton:
                            text: "Valider la Vente"
                            on_release: app.validate_sale()
